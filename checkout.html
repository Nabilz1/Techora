<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Techora - Checkout</title>
<style>
  * { margin:0; padding:0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
  body { background:#f9f9f9; color:#333; min-height: 100vh; display:flex; flex-direction: column; }
  header, footer { background:#222; color:#fff; padding:20px 0; text-align:center; }
  nav ul { display:flex; justify-content:center; list-style:none; flex-wrap:wrap; margin-top:10px; }
  nav ul li { margin:0 15px; }
  nav ul li a { color:#fff; text-decoration:none; font-weight:500; }
  nav ul li a:hover { color:#00bcd4; }
  main { flex:1; max-width: 800px; margin: 40px auto; background:#fff; padding:30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  h2 { margin-bottom: 20px; text-align:center; }
  .section { margin-bottom: 30px; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border-bottom: 1px solid #ddd; padding: 10px; text-align: left; }
  th { background:#00bcd4; color:#fff; }
  label { display:block; margin: 12px 0 6px; font-weight: 600; }
  input, select, textarea {
    width: 100%; padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 5px;
  }
  button {
    background: #00bcd4; border: none; padding: 12px 20px; color: white; font-weight: 700;
    font-size: 1.1rem; cursor: pointer; border-radius: 5px; margin-top: 15px; display: block; width: 100%;
    transition: background-color 0.3s;
  }
  button:hover { background: #007c91; }
  #paypal-button-container { margin-top: 20px; }
  #logout-btn {
    background: #f44336; margin-top: 10px; cursor: pointer; border-radius: 5px; padding: 8px 15px; border: none; color: white;
  }
  #welcome-msg {
    color: #00bcd4; margin-bottom: 15px; text-align: center; font-weight: 600;
  }
  #empty-cart-msg {
    text-align: center; color: #777; font-size: 1.2rem; margin: 40px 0;
  }
</style>
</head>
<body>

<header>
  <h1>Techora</h1>
  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="products.html">Products</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="cart.html">ðŸ›’ Cart (<span id="cart-count">0</span>)</a></li>
    </ul>
  </nav>
  <div style="text-align:center; margin-top:8px;">
    <span id="welcome-msg"></span>
    <button id="logout-btn" style="display:none;">Log Out</button>
  </div>
</header>

<main>
  <h2>Checkout</h2>

  <div id="empty-cart-msg" style="display:none;">Your cart is empty. <a href="products.html">Shop now</a>.</div>

  <div id="checkout-content" style="display:none;">
    <div class="section">
      <h3>Order Summary</h3>
      <table id="order-summary">
        <thead>
          <tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><th colspan="3" style="text-align:right;">Grand Total:</th><th id="grand-total">$0.00</th></tr>
        </tfoot>
      </table>
    </div>

    <div class="section">
      <h3>Delivery Details</h3>
      <form id="delivery-form">
        <label for="name">Full Name</label>
        <input type="text" id="name" required />

        <label for="address">Address</label>
        <textarea id="address" rows="3" required></textarea>

        <label for="email">Email</label>
        <input type="email" id="email" required />

        <label for="phone">Phone Number</label>
        <input type="tel" id="phone" required />
      </form>
    </div>

    <div class="section">
      <h3>Payment Method</h3>
      <p>Pay with PayPal</p>
      <div id="paypal-button-container"></div>
    </div>
  </div>
</main>

<footer>
  <p>&copy; 2025 Techora. All rights reserved.</p>
</footer>

<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>

<script>
  const cartCountSpan = document.querySelector('nav ul li a[href="cart.html"] span');
  const welcomeMsg = document.getElementById('welcome-msg');
  const logoutBtn = document.getElementById('logout-btn');

  // Check login, redirect if not logged in
  const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
  if (!loggedInUser || !loggedInUser.username) {
    alert('You must be logged in to proceed to checkout.');
    window.location.href = 'login.html';
  } else {
    welcomeMsg.textContent = `Welcome, ${loggedInUser.username}!`;
    logoutBtn.style.display = 'inline-block';
  }

  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('loggedInUser');
    alert('You have been logged out.');
    window.location.href = 'login.html';
  });

  // Load cart and update counts
  function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const totalCount = cart.reduce((sum, item) => sum + item.quantity, 0);
    if (cartCountSpan) cartCountSpan.textContent = totalCount;
  }

  updateCartCount();

  // Display order summary
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const checkoutContent = document.getElementById('checkout-content');
  const emptyCartMsg = document.getElementById('empty-cart-msg');
  const orderSummaryBody = document.querySelector('#order-summary tbody');
  const grandTotalElem = document.getElementById('grand-total');

  if (cart.length === 0) {
    emptyCartMsg.style.display = 'block';
    checkoutContent.style.display = 'none';
  } else {
    emptyCartMsg.style.display = 'none';
    checkoutContent.style.display = 'block';

    let grandTotal = 0;
    orderSummaryBody.innerHTML = '';
    cart.forEach(item => {
      const total = item.price * item.quantity;
      grandTotal += total;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.name}</td>
        <td>${item.quantity}</td>
        <td>$${item.price.toFixed(2)}</td>
        <td>$${total.toFixed(2)}</td>
      `;
      orderSummaryBody.appendChild(tr);
    });
    grandTotalElem.textContent = `$${grandTotal.toFixed(2)}`;
  }

  // PayPal Button setup
  // Replace "sb" client-id in SDK URL with your real client-id for production!
  // We will use your business email in createOrder
  paypal.Buttons({
    onClick: function(data, actions) {
      // Validate delivery form before payment
      const name = document.getElementById('name').value.trim();
      const address = document.getElementById('address').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      if (!name || !address || !email || !phone) {
        alert('Please fill in all delivery details before proceeding.');
        return actions.reject();
      }
      return actions.resolve();
    },
    createOrder: function(data, actions) {
      const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      return actions.order.create({
        purchase_units: [{
          amount: {
            value: total.toFixed(2)
          },
          payee: {
            email_address: 'Nabil.R1q@gmail.com'
          }
        }]
      });
    },
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        alert('Payment completed! Thank you, ' + details.payer.name.given_name + '. Your order is confirmed.');
        // Clear cart after payment
        localStorage.removeItem('cart');
        updateCartCount();
        // Redirect to home or thank you page (here, home)
        window.location.href = 'index.html';
      });
    },
    onError: function(err) {
      alert('Payment could not be completed. Please try again.');
      console.error(err);
    }
  }).render('#paypal-button-container');
</script>

</body>
</html>
